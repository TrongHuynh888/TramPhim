<div id="watchPartyPage" class="page">
  <div id="partyLobby" class="party-container">
    <div class="section-header">
      <h2 class="section-title">Ph√≤ng Xem Chung üçø</h2>
      <button class="btn btn-primary" onclick="openCreateRoomModal()">
        <i class="fas fa-plus-circle"></i> T·∫°o Ph√≤ng M·ªõi
      </button>
    </div>

    <div class="party-grid" id="roomList">
      <div class="loading-spinner"></div>
    </div>
  </div>

  <div id="partyRoom" class="hidden">
    <div class="room-layout">
      <div class="room-main">
        <div class="room-header-bar">
          <button class="btn btn-secondary btn-sm" onclick="leaveRoom()">
            <i class="fas fa-arrow-left"></i> R·ªùi ph√≤ng
          </button>
          <h3 id="roomTitleDisplay">T√™n Ph√≤ng</h3>
          <div class="room-meta">
            <button
              id="roomInviteBtn"
              class="btn btn-sm btn-neon"
              onclick="copyRoomLink()"
              title="Sao ch√©p li√™n k·∫øt chia s·∫ª"
            >
              <i class="fas fa-link"></i> M·ªùi b·∫°n b√®
            </button>

            <span class="live-badge">LIVE</span>
          </div>
        </div>

        <div class="video-container room-player-wrapper" id="wpVideoContainer">
          <div id="floatingEmojis" class="floating-emojis"></div>

          <div id="partyPlayer"></div>

          <div id="syncStatus" class="sync-overlay hidden">
            <div class="spinner-border"></div>
            <span>ƒêang ƒë·ªìng b·ªô...</span>
          </div>

          <!-- Watch Party Center Controls (Host/Admin only for play/skip, shown for all) -->
          <div class="wp-center-overlay" id="wpCenterOverlay">
              <button class="center-btn skip-btn" onclick="syncSeek(-10)" title="L√πi 10s">
                  <i class="fas fa-undo-alt"></i>
              </button>
              <button class="center-btn play-btn-large" id="wpPlayBtn" onclick="syncPlay()" title="Play/Pause">
                  <i class="fas fa-play" id="wpPlayIcon"></i>
              </button>
              <button class="center-btn skip-btn" onclick="syncSeek(10)" title="Ti·∫øn 10s">
                  <i class="fas fa-redo-alt"></i>
              </button>
          </div>

          <!-- Watch Party Bottom Controls -->
          <div class="wp-controls-bar" id="wpControlsBar">
              <!-- Progress Bar -->
              <div class="wp-progress-container" id="wpProgressContainer">
                  <div class="wp-progress-filled" id="wpProgressBar"></div>
                  <div class="wp-progress-buffer" id="wpBufferBar"></div>
                  <input type="range" class="wp-progress-slider" id="wpProgressSlider" min="0" max="100" value="0" step="0.1">
              </div>
              
              <div class="wp-controls-row">
                  <!-- Left -->
                  <div class="wp-controls-left">
                      <button class="wp-ctrl-btn" id="wpPlayPauseBtn" onclick="syncPlay()">
                          <i class="fas fa-play"></i>
                      </button>
                      <div class="wp-volume-container">
                          <button class="wp-ctrl-btn" id="wpVolumeBtn" onclick="wpToggleMute()">
                              <i class="fas fa-volume-up"></i>
                          </button>
                          <div class="wp-volume-wrapper">
                              <input type="range" class="wp-volume-slider" id="wpVolumeSlider" min="0" max="1" step="0.05" value="1">
                          </div>
                      </div>
                      <div class="wp-time-display">
                          <span id="wpCurrentTime">00:00</span> / <span id="wpDuration">00:00</span>
                      </div>
                  </div>
                  <!-- Right -->
                  <div class="wp-controls-right">
                      <!-- Settings (All users) -->
                      <div class="wp-settings-container" id="wpSettingsContainer">
                          <button class="wp-ctrl-btn" id="wpSettingsBtn" onclick="wpToggleSettings()">
                              <i class="fas fa-cog"></i>
                          </button>
                          <div class="settings-menu" id="wpSettingsMenu" style="display:none;">
                              <div class="settings-item" onclick="wpShowSubMenu('speed')">
                                  <span>T·ªëc ƒë·ªô</span>
                                  <span class="settings-value" id="wpSpeedVal">Chu·∫©n</span>
                                  <i class="fas fa-chevron-right"></i>
                              </div>
                              <div class="settings-item" id="wpQualityItem" onclick="wpShowSubMenu('quality')" style="display:none;">
                                  <span>Ch·∫•t l∆∞·ª£ng</span>
                                  <span class="settings-value" id="wpQualityVal">T·ª± ƒë·ªông</span>
                                  <i class="fas fa-chevron-right"></i>
                              </div>
                              <div class="settings-item" onclick="wpShowSubMenu('color')">
                                  <span>M√†u ph·ª• ƒë·ªÅ</span>
                                  <span class="settings-value" id="wpColorVal">White</span>
                                  <i class="fas fa-chevron-right"></i>
                              </div>
                          </div>
                          <div class="settings-submenu" id="wpSpeedMenu" style="display:none;">
                              <div class="submenu-header" onclick="wpHideSubMenu()"><i class="fas fa-chevron-left"></i> T·ªëc ƒë·ªô</div>
                              <div class="submenu-item" onclick="wpSetSpeed(0.5)">0.5x</div>
                              <div class="submenu-item" onclick="wpSetSpeed(0.75)">0.75x</div>
                              <div class="submenu-item active" onclick="wpSetSpeed(1)">Chu·∫©n</div>
                              <div class="submenu-item" onclick="wpSetSpeed(1.25)">1.25x</div>
                              <div class="submenu-item" onclick="wpSetSpeed(1.5)">1.5x</div>
                              <div class="submenu-item" onclick="wpSetSpeed(2)">2x</div>
                          </div>
                          <div class="settings-submenu" id="wpQualityMenu" style="display:none;">
                              <div class="submenu-header" onclick="wpHideSubMenu()"><i class="fas fa-chevron-left"></i> Ch·∫•t l∆∞·ª£ng</div>
                              <div class="submenu-item active" data-level="-1" onclick="wpSetQuality(-1)">T·ª± ƒë·ªông</div>
                          </div>
                          <!-- Color Submenu -->
                          <div class="settings-submenu" id="wpColorMenu" style="display:none;">
                              <div class="submenu-header" onclick="wpHideSubMenu()"><i class="fas fa-chevron-left"></i> M√†u ph·ª• ƒë·ªÅ</div>
                              <div class="submenu-item active" data-color="white" onclick="wpSetSubtitleColor('white')">TR·∫ÆNG</div>
                              <div class="submenu-item" data-color="yellow" onclick="wpSetSubtitleColor('yellow')" style="color: yellow;">V√ÄNG</div>
                              <div class="submenu-item" data-color="cyan" onclick="wpSetSubtitleColor('cyan')" style="color: cyan;">XANH D∆Ø∆†NG</div>
                              <div class="submenu-item" data-color="green" onclick="wpSetSubtitleColor('green')" style="color: #4caf50;">XANH L√Å</div>
                          </div>
                      </div>
                      <!-- Fullscreen (All users) -->
                      <button class="wp-ctrl-btn" id="wpFullscreenBtn" onclick="wpToggleFullscreen()">
                          <i class="fas fa-expand"></i>
                      </button>
                  </div>
              </div>
          </div>
        </div>


      </div>

      <div class="room-sidebar">
        <div class="room-tabs">
          <button class="room-tab active" onclick="switchRoomTab('chat')">
            Chat
          </button>
          <button class="room-tab" onclick="switchRoomTab('members')">
            Th√†nh vi√™n (<span id="memberCount">0</span>)
          </button>
        </div>

        <div id="tabChat" class="room-tab-content active">
          <div class="chat-messages" id="chatMessages">
            <div class="system-msg">Ch√†o m·ª´ng ƒë·∫øn ph√≤ng chat!</div>
          </div>
          <div class="emoji-bar">
            <span onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="sendReaction('üòÇ')">üòÇ</span>
            <span onclick="sendReaction('üòÆ')">üòÆ</span>
            <span onclick="sendReaction('üò≠')">üò≠</span>
            <span onclick="sendReaction('üò°')">üò°</span>
            <span onclick="sendReaction('üéâ')">üéâ</span>
          </div>
          <form class="chat-input-area" onsubmit="sendChatMessage(event)">
            <input
              type="text"
              id="chatInput"
              placeholder="Chat g√¨ ƒë√≥..."
              autocomplete="off"
            />
            <button type="submit"><i class="fas fa-paper-plane"></i></button>
          </form>
        </div>

        <div id="tabMembers" class="room-tab-content">
          <div class="member-list" id="memberList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="createRoomModal">
  <div class="modal" style="max-width: 500px">
    <div class="modal-header">
      <h3>T·∫°o Ph√≤ng Xem Chung</h3>
      <button class="modal-close" onclick="closeModal('createRoomModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form onsubmit="handleCreateRoom(event)">
        <div class="form-group">
          <label>T√™n ph√≤ng</label>
          <input
            type="text"
            class="form-input"
            id="roomNameInput"
            required
            placeholder="VD: Xem phim kinh d·ªã..."
          />
        </div>
        <div class="form-group">
          <label>Ch·ªçn phim</label>
          <select
            class="form-select"
            id="roomMovieSelect"
            required
            onchange="updateEpisodeSelect()"
          >
            <option value="">-- Ch·ªçn phim --</option>
          </select>
        </div>
        <div class="form-group hidden" id="roomEpisodeGroup">
          <label>Ch·ªçn t·∫≠p</label>
          <select class="form-select" id="roomEpisodeSelect"></select>
        </div>
        <div class="form-group">
          <label>Lo·∫°i ph√≤ng</label>
          <select class="form-select" id="roomType" onchange="toggleRoomPass()">
            <option value="public">C√¥ng khai</option>
            <option value="private">Ri√™ng t∆∞ (M·∫≠t kh·∫©u)</option>
          </select>
        </div>
        <div class="form-group hidden" id="roomPassGroup">
          <label>M·∫≠t kh·∫©u</label>
          <div class="password-input-wrapper">
            <input
              type="password"
              class="form-input"
              id="roomPassword"
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."
              autocomplete="new-password"
            />
            <i class="fas fa-eye password-toggle-icon" onclick="togglePassword('roomPassword', this)"></i>
          </div>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%">
          T·∫°o & V√†o Ngay üöÄ
        </button>
      </form>
    </div>
  </div>
</div>
